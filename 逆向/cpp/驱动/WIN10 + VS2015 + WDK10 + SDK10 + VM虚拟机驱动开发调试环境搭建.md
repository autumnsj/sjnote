WIN10 + VS2015 + WDK10 + SDK10 + VM虚拟机驱动开发调\
试环境搭建\
责任编辑：词汇网 发表时间：2016-3-25 20:42:51\
牛评：我要评论\
一、准备工作1 系统环境：Win10系统2 开发工具：VS20153驱动开发工具：WDK104
Windows SDK\
：SDK10(VS2015中可以勾选安装)5 VM虚拟机 ：VMware WorkStation 12\
win10
64位下驱动安装工具下载地址(此工具只在上述环境下测试过,请在虚拟机中测试过再在真实环境\
下安装否则蓝屏自己负责)\
http://download.csdn.net/detail/qing666888/9468506\
注意事项：关闭 、主机 客户机 防火墙 、 互相ping都能ping通。\
二、具体操作步骤\
工具安装就不说了，不会的百度一下。只说一下一些关键的地方。1、安装好虚拟机后，给虚拟机增加\
一个串口设备。具体操作见图：

完成配置后虚拟机设备配置就多了一个串行端口的设备。因为打印机用了端口1。所以设备里面显示的\
是串行端口（如果想设置成端口1，把打印机设备删了在添加串口设备）。\
2、配置虚拟机系统为调试模式\
以管理员身份，在虚拟机命令行模式下运行如下2个命令开启。\
bcdedit /debug on\
bcdedit /dbgsettings serial debugport:1 baudrate:115200\
where is the number of a COM port on the virtual
machine.（n时虚拟机的一个COM端口号。就是设备\
显示的串行端口2，n就是端口2）。\
3、把WDK10的虚拟机调试驱动拷贝到虚拟机中安装。

因为VS2015可以调试x86 x64两种驱动所以两个都拷贝到虚拟机安装。\
4、VS2015开发工具配置在VS2015的菜单栏点击DRIVER\--TEST\--CONFIGURE
DEVICES会报错估\
计是VS2015的Bug求大神指点。如图\
这里不行我们换个地方配置，从工程属性里面进行配置。右键工程属性配置从这也可以进行测试设备\
的配置：

配置界面，下面两个选项第一项由VS2015帮我们创建一个WDKuser测试账户，自动打开测试模式等。\
第二个是使用我们自己配置的参数。由于上面我们已经配置了串口参数
、设置了调试模式所以我们选\
择第二个就行了。

如下配置在内核模式中，选择串口、配置好波特率、勾上2个选项、管道名称、端口号。

出现上述红色框字样则说明配置已经成功了。（不要开启全局代理软件，否则会出现连接不上的问\
题）。\
5、使用工具安装调试64位驱动\
网上下的下面的驱动安装软件貌似64位的都用不了。\
自己动手丰衣足食\
大笑\
，自己在网上弄了个源码改了下弄成可以加载64位的驱动的版本了。

使用DebugView打印内核调试信息是开发驱动的非常重要的手段，但DebugView默认在WINDOWS
10\
下却无法获取内核的调试日志，驱动调用KdPint/DbgPrint等的打印结果是无法被DebugView给捕捉到\
的。设置方法如下（复制下面的代码到txt文件。改后缀为.reg后执行，然后重启电脑）：\
Windows Registry Editor Version\
5.00\[HKEY_LOCAL_MACHINE\\SYSTEM\\CurrentControlSet\\Control\\Session
Manager\\Debug Print\
Filter\]\"DEFAULT\"=dword:0000000f\
还有自己编译出来的驱动要使用编译的Debug版本来测试，Release版本是不会执行KdPrint/DbgPint函\
数的。\
下面是在Win10
64位的虚拟机中用此安装程序，加载64位的驱动以及用DebugView查看驱动打印消息\
的截图结果。\
6、在VS2015中下断点进行调试\
如果你第五部已经完成了，并且在DebugView中已经能够输出调试的打印信息了，辣么骚年你已经离\
成功只有一部之遥了

大笑\
。\
创建一个驱动工程，WDK10提供的模板中根本没有提供NT驱动模板，我们如何创建NT驱动呢?\
解决：其实虽然没有提供NT模板，但是我们可以建立WDM空模板工程，然后再自己添加文件，编译，\
得到的也就是NT驱动了。\
驱动工程中会帮你建立一个inf文件，NT是使用不到的，可以直接删除。我们直接添加一个MyDriver.c\
在文件中添加测试代码。\
#include VOID DriverUnload(PDRIVER_OBJECT objDriver){//
避免编译器关于未引用参数的警告\
UNREFERENCED_PARAMETER(objDriver);//
什么也不做，只打印一行字符串KdPrint((\"My Dirver is\
Ending\...\"));}NTSTATUS DriverEntry(PDRIVER_OBJECT objDriver,
PUNICODE_STRING\
strRegPath){//
避免编译器关于未引用参数的警告UNREFERENCED_PARAMETER(strRegPath);// 打\
印一行字符串，并注册驱动卸载函数，以便于驱动卸载KdPrint((\"My Dirver Is
Starting!\\r\\n\"));objDriver-\
\>DriverUnload = DriverUnload;return STATUS_SUCCESS;}\
编译，报错,没有关系，这些都是因为安全警告等级太高了，我们可以降低编译器警告等级的方式解\
决：

执行编译，编译的时候选择Debug模式，X64的选项。编译成功后，按照上面的第五步进行基本测试可\
以。

不知不觉感觉已经写了好长了。。。。\
奋斗\
抽口烟压压精。好吧我不抽烟的。。。。。继续如果上述的驱动成功编译出来了。辣么现在我们开始\
附加虚拟机的内核进行调试了。首先把虚拟机的系统内核附加到VS2015，具体步骤见下图：

选中内核调试模式、选自己配置的那个电脑、选中下面列表中内核。见下图

点击附加，然后出现下图界面,点击一下全部中断。\
然后系统就断下了，虚拟机的系统我们鼠标已经点不了，现在系统处于挂起状态了。见下图

现在我们可以到源代码中下断点了。我就随便下个断点了，见图：\
然后我们在下面的Debugger Immediate Winddow窗口的 Kd\> 一行输入命令 g
让系统运行起来。这样\
虚拟机中的系统又可以点击了。\
最后一步了。使用我们刚刚建立的驱动工程编译出来的.sys驱动文件拷贝到虚拟机中。用第五步的工具\
进行安装、启动。启动的时候自动触发VS2015中的下的断点。至此可以像平时我们调试程序一样进行\
单步调试了。注意事项：1、一定要拷贝Debug版本的进行调试。
2、拷贝到虚拟机中的.sys文件一定\
要是你源码编译出来的。如果改动了源码后一定要重新拷贝一份新的驱动文件到虚拟机中调试。否则\
无法触发断点的。

三、结束语
本人也是刚开始研究驱动开发，上述如果有什么不对的请大家指点、共同交流。\
至此整个调试过程已经结束，谢谢各位看官能够耐心读完，如果觉得写的还可以请在下面顶一个。谢\
谢大家支持。。。。\
大笑
